#!/bin/bash
# =============================================================================
# chirp - Docker-based build and flash utility for IWR6843AOPEVM
# =============================================================================
#
# Usage:
#   ./docker/chirp build          Build firmware
#   ./docker/chirp shell          Interactive shell in container
#   ./docker/chirp clean          Clean build artifacts
#   ./docker/chirp flash [port]   Flash firmware (runs natively)
#   ./docker/chirp setup          Download/setup toolchains
#
# =============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Docker image name
IMAGE_NAME="chirp-build"

# Detect OS
detect_os() {
    case "$(uname -s)" in
        Darwin*)    echo "macos" ;;
        Linux*)     echo "linux" ;;
        MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
        *)          echo "unknown" ;;
    esac
}

OS=$(detect_os)

# Detect architecture
detect_arch() {
    case "$(uname -m)" in
        x86_64|amd64)   echo "amd64" ;;
        arm64|aarch64)  echo "arm64" ;;
        *)              echo "unknown" ;;
    esac
}

ARCH=$(detect_arch)

# Find toolchain path
find_toolchain_path() {
    # Check environment variable first
    if [[ -n "$TOOLCHAIN_PATH" ]] && [[ -d "$TOOLCHAIN_PATH" ]]; then
        echo "$TOOLCHAIN_PATH"
        return
    fi

    # Check common locations
    local paths=(
        "$PROJECT_ROOT"                           # Same as project
        "$HOME/ti"                                # TI default on Mac/Linux
        "/opt/ti"                                 # System install
        "$PROJECT_ROOT/../ti-toolchains"          # Sibling directory
    )

    for path in "${paths[@]}"; do
        if [[ -d "$path/ti-cgt-arm_16.9.6.LTS" ]]; then
            echo "$path"
            return
        fi
    done

    # Not found
    echo ""
}

# Print banner
print_banner() {
    echo -e "${CYAN}"
    echo "  ╔═══════════════════════════════════════════╗"
    echo "  ║              chirp build tool             ║"
    echo "  ║          IWR6843AOPEVM Development        ║"
    echo "  ╚═══════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Print help
print_help() {
    print_banner
    echo -e "${BOLD}USAGE${NC}"
    echo "    chirp <command> [options]"
    echo ""
    echo -e "${BOLD}COMMANDS${NC}"
    echo "    build           Build firmware in Docker container"
    echo "    shell           Interactive shell in container"
    echo "    clean           Clean build artifacts"
    echo "    flash [port]    Flash firmware to device (native)"
    echo "    setup           Setup/download toolchains"
    echo "    status          Show environment status"
    echo "    help            Show this help"
    echo ""
    echo -e "${BOLD}ENVIRONMENT${NC}"
    echo "    TOOLCHAIN_PATH  Path to TI toolchains (auto-detected)"
    echo ""
    echo -e "${BOLD}EXAMPLES${NC}"
    echo "    chirp build                    # Build firmware"
    echo "    chirp flash /dev/ttyUSB2       # Flash to device"
    echo "    chirp shell                    # Debug in container"
    echo ""
}

# Check Docker availability
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}ERROR: Docker not found${NC}"
        echo ""
        echo "Install Docker Desktop from: https://www.docker.com/products/docker-desktop"
        exit 1
    fi

    if ! docker info &> /dev/null; then
        echo -e "${RED}ERROR: Docker daemon not running${NC}"
        echo ""
        echo "Start Docker Desktop and try again."
        exit 1
    fi
}

# Build Docker image if needed
ensure_image() {
    if ! docker image inspect "$IMAGE_NAME" &> /dev/null; then
        echo -e "${YELLOW}Building Docker image (first time only)...${NC}"
        docker build -t "$IMAGE_NAME" -f "$SCRIPT_DIR/Dockerfile" "$PROJECT_ROOT"
    fi
}

# Run container with proper mounts
run_container() {
    local cmd=("$@")
    local toolchain_path=$(find_toolchain_path)

    if [[ -z "$toolchain_path" ]]; then
        echo -e "${RED}ERROR: Toolchains not found${NC}"
        echo ""
        echo "Set TOOLCHAIN_PATH or run: chirp setup"
        exit 1
    fi

    # Platform-specific options
    local platform_opts=""
    if [[ "$OS" == "macos" ]] && [[ "$ARCH" == "arm64" ]]; then
        platform_opts="--platform linux/amd64"
    fi

    docker run --rm \
        $platform_opts \
        -v "$PROJECT_ROOT:/workspace" \
        -v "$toolchain_path:/opt/ti" \
        -e "VITAL_SIGNS=${VITAL_SIGNS:-1}" \
        -e "USE_LOCAL_MATHLIB=${USE_LOCAL_MATHLIB:-1}" \
        -e "USE_LOCAL_MATHUTILS=${USE_LOCAL_MATHUTILS:-1}" \
        -e "USE_LOCAL_DSPLIB=${USE_LOCAL_DSPLIB:-0}" \
        "$IMAGE_NAME" \
        "${cmd[@]}"
}

# Run interactive shell
run_shell() {
    local toolchain_path=$(find_toolchain_path)

    if [[ -z "$toolchain_path" ]]; then
        echo -e "${RED}ERROR: Toolchains not found${NC}"
        exit 1
    fi

    local platform_opts=""
    if [[ "$OS" == "macos" ]] && [[ "$ARCH" == "arm64" ]]; then
        platform_opts="--platform linux/amd64"
    fi

    docker run --rm -it \
        $platform_opts \
        -v "$PROJECT_ROOT:/workspace" \
        -v "$toolchain_path:/opt/ti" \
        "$IMAGE_NAME" \
        /bin/bash
}

# Build firmware
cmd_build() {
    print_banner
    echo -e "${YELLOW}Platform: ${OS} (${ARCH})${NC}"
    echo ""

    check_docker
    ensure_image
    run_container ./docker/scripts/build.sh
}

# Clean artifacts
cmd_clean() {
    check_docker
    ensure_image
    run_container ./docker/scripts/clean.sh
}

# Interactive shell
cmd_shell() {
    print_banner
    check_docker
    ensure_image
    run_shell
}

# Flash firmware (native - no Docker needed)
cmd_flash() {
    local port="${1:-/dev/ttyUSB2}"

    # On Mac, adjust port name
    if [[ "$OS" == "macos" ]]; then
        if [[ "$port" == "/dev/ttyUSB"* ]]; then
            echo -e "${YELLOW}Note: On Mac, serial ports are typically /dev/tty.usbserial-*${NC}"
            echo ""
            echo "Available ports:"
            ls /dev/tty.usbserial* /dev/tty.SLAB* 2>/dev/null || echo "  (none found)"
            echo ""
        fi
    fi

    # Run native flash script (Python)
    python3 "$PROJECT_ROOT/scripts/flash/flash_direct.py" -p "$port" \
        "$PROJECT_ROOT/firmware/custom/iwr6843aop_mmw_vitalsigns.bin"
}

# Show status
cmd_status() {
    print_banner

    echo -e "${BOLD}System${NC}"
    echo "  OS:           $OS"
    echo "  Architecture: $ARCH"
    echo ""

    echo -e "${BOLD}Docker${NC}"
    if command -v docker &> /dev/null; then
        if docker info &> /dev/null; then
            echo -e "  Status:       ${GREEN}Running${NC}"
            if docker image inspect "$IMAGE_NAME" &> /dev/null; then
                echo -e "  Image:        ${GREEN}Built${NC}"
            else
                echo -e "  Image:        ${YELLOW}Not built (run: chirp build)${NC}"
            fi
        else
            echo -e "  Status:       ${RED}Not running${NC}"
        fi
    else
        echo -e "  Status:       ${RED}Not installed${NC}"
    fi
    echo ""

    echo -e "${BOLD}Toolchains${NC}"
    local toolchain_path=$(find_toolchain_path)
    if [[ -n "$toolchain_path" ]]; then
        echo -e "  Path:         ${GREEN}$toolchain_path${NC}"

        local components=(
            "ti-cgt-arm_16.9.6.LTS:ARM Compiler"
            "ti-cgt-c6000_8.3.3:DSP Compiler"
            "xdctools_3_50_08_24_core:XDC Tools"
            "bios_6_73_01_01:SYS/BIOS"
            "packages:mmWave SDK"
        )

        for comp in "${components[@]}"; do
            local dir="${comp%%:*}"
            local name="${comp##*:}"
            if [[ -d "$toolchain_path/$dir" ]]; then
                echo -e "  $name: ${GREEN}Found${NC}"
            else
                echo -e "  $name: ${RED}Missing${NC}"
            fi
        done
    else
        echo -e "  Path:         ${RED}Not found${NC}"
        echo ""
        echo "  Set TOOLCHAIN_PATH or run: chirp setup"
    fi
    echo ""

    echo -e "${BOLD}Firmware${NC}"
    local fw="$PROJECT_ROOT/firmware/custom/iwr6843aop_mmw_vitalsigns.bin"
    if [[ -f "$fw" ]]; then
        echo -e "  Status:       ${GREEN}Built${NC}"
        echo "  Size:         $(du -h "$fw" | cut -f1)"
        echo "  Modified:     $(stat -c %y "$fw" 2>/dev/null || stat -f %Sm "$fw" 2>/dev/null)"
    else
        echo -e "  Status:       ${YELLOW}Not built${NC}"
    fi
    echo ""
}

# Setup toolchains
cmd_setup() {
    print_banner
    echo -e "${BOLD}Toolchain Setup${NC}"
    echo ""
    echo "The TI toolchains must be downloaded separately due to licensing."
    echo ""
    echo -e "${YELLOW}Required components:${NC}"
    echo "  1. TI ARM Compiler (ti-cgt-arm_16.9.6.LTS)"
    echo "  2. TI C6000 Compiler (ti-cgt-c6000_8.3.3)"
    echo "  3. XDC Tools (xdctools_3_50_08_24_core)"
    echo "  4. SYS/BIOS (bios_6_73_01_01)"
    echo "  5. mmWave SDK packages"
    echo "  6. DSPLib C674x (dsplib_c674x_3_4_0_0)"
    echo "  7. MathLib C674x (mathlib_c674x_3_1_2_1)"
    echo ""
    echo -e "${YELLOW}Download from:${NC}"
    echo "  https://www.ti.com/tool/MMWAVE-SDK"
    echo "  https://www.ti.com/tool/TI-CGT"
    echo ""
    echo -e "${YELLOW}Installation:${NC}"
    echo "  1. Download and extract all components to a single directory"
    echo "  2. Set TOOLCHAIN_PATH to that directory:"
    echo "     export TOOLCHAIN_PATH=/path/to/ti/toolchains"
    echo ""
    echo "  Or place them alongside this project:"
    echo "     $(dirname "$PROJECT_ROOT")/ti-cgt-arm_16.9.6.LTS"
    echo "     $(dirname "$PROJECT_ROOT")/ti-cgt-c6000_8.3.3"
    echo "     ... etc"
    echo ""
}

# =============================================================================
# Main
# =============================================================================

cd "$PROJECT_ROOT"

case "${1:-help}" in
    build)
        cmd_build
        ;;
    shell)
        cmd_shell
        ;;
    clean)
        cmd_clean
        ;;
    flash)
        cmd_flash "$2"
        ;;
    setup)
        cmd_setup
        ;;
    status)
        cmd_status
        ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        print_help
        exit 1
        ;;
esac
